import urllib.request
import gridfs
import os
import hashlib
import ssdeep
import pefile
import json
import requests
import mimetypes
from virustotal_python import Virustotal

fpath = 'report/'
dir_path = os.path.dirname(os.path.realpath(__file__))

def get_ip_malware(db, address_ip):
    print("\n********************")
    print("****PRINT IP DB****") 
    print("********************")

    collection_ip = db['ip_collection']
    collection_malware = db['malware_collection']
    cursor_ip = collection_ip.find({ "address_ip": address_ip })
    print("\n*** IP_COLLECTION ***") 
    for document_ip in cursor_ip:
        for x in document_ip:
            print(x + ':', document_ip[x])
        print("\n")
        print("\n*** MALWARE_COLLECTION ***")
        cursor_malware = collection_malware.find({ "id_malware": document_ip['id_malware_ip']})
        for document_malware in cursor_malware:
            for x in document_malware:
                print(x + ':', document_malware[x])
    print("\n")
    print("********************")
    print("**END PRINT IP DB**")
    print("********************")

def get_hash_malware(db, type_hash, hash_value):
    print("\n********************")
    print("****PRINT HASH DB****") 
    print("********************")
    
    column_name = type_hash + "_malware"

    collection_malware = db['malware_collection']
    collection_ip = db['ip_collection']
    cursor_malware = collection_malware.find({ column_name: hash_value })
    print("\n*** MALWARE_COLLECTION ***") 
    for document_malware in cursor_malware:
        for x in document_malware:
            print(x + ':', document_malware[x])
        print("\n")
        print("\n*** IP_COLLECTION ***")
        cursor_ip = collection_ip.find({ "id_malware_ip": document_malware['id_malware'] })
        for document_ip in cursor_ip:
            for x in document_ip:
                print(x + ':', document_ip[x])

    print("\n")
    print("********************")
    print("**END PRINT HASH DB**")
    print("********************")

def get_label_malware(db, label):
    print("\n********************")
    print("****PRINT LABEL DB****") 
    print("********************")

    collection_label = db['label_collection']
    collection_malware = db['malware_collection']
    cursor_label = collection_label.find({ "label": label })
    print("\n*** LABEL_COLLECTION ***") 
    for document_label in cursor_label:
        for x in document_label:
            print(x + ':', document_label[x])
        print("\n")
        print("\n*** MALWARE_COLLECTION ***")
        cursor_malware = collection_malware.find({ "id_malware": document_label['id_malware_label']})
        for document_malware in cursor_malware:
            for x in document_malware:
                print(x + ':', document_malware[x])
    print("\n")
    print("********************")
    print("**END PRINT LABEL DB**")
    print("********************")


